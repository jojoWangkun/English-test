<!DOCTYPE html>
<meta charset="utf-8">
<title>答题入口-选择题库</title>
<style>
  body{max-width:500px;margin:50px auto;font-family:Arial;padding:0 20px}
  .form-group{margin:20px 0}
  label{display:block;margin-bottom:8px;font-weight:bold;font-size:16px}
  input{width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;font-size:16px;box-sizing:border-box}
  .btn{width:100%;padding:15px;font-size:18px;border:none;border-radius:8px;color:white;background:#4CAF50;cursor:pointer;margin:5px 0}
  .btn:hover{opacity:0.9}
  .empty{text-align:center;padding:30px;color:#666;border:1px dashed #ccc;border-radius:8px;margin:20px 0}
  .loading{text-align:center;color:#666;margin:20px 0}
</style>
<h1>开始答题</h1>
<div class="form-group">
  <label for="userName">请输入你的姓名：</label>
  <input type="text" id="userName" placeholder="例如：张三" required>
</div>
<div id="fileList" class="loading">正在加载题库...</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // ✅ 修复process未定义：本地直接填令牌
  const GITHUB_TOKEN =
  typeof process !== "undefined" && process.env.GITHUB_TOKEN
    ? process.env.GITHUB_TOKEN
    : "";
  const GITHUB_REPO = "jojoWangkun/English-test";
  const FOLDER_PATH = "questions";

  window.onload = loadFileList;

  // 加载题库文件列表
  async function loadFileList() {
    const fileList = document.getElementById('fileList');
    try {
      const requestUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FOLDER_PATH}`;
      const response = await fetch(requestUrl, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        mode: 'cors'
      });

      if (!response.ok) {
        fileList.innerHTML = "<div class='empty'>题库加载失败，请检查GitHub配置</div>";
        return;
      }

      const files = await response.json();
      const excelFiles = files.filter(file => file.name.endsWith('.xlsx'));

      if (excelFiles.length === 0) {
        fileList.innerHTML = "<div class='empty'>暂无可用题库，请先上传Excel题库</div>";
        return;
      }

      let btnHtml = "";
      excelFiles.forEach(file => {
        btnHtml += `<button class="btn" onclick="startTest('${file.name}')">${file.name}</button>`;
      });
      fileList.innerHTML = btnHtml;
    } catch (error) {
      fileList.innerHTML = `<div class='empty'>加载失败：${error.message}</div>`;
      console.error("题库加载错误：", error);
    }
  }

  // 跳转到答题页
  function startTest(fileName) {
    const userName = document.getElementById('userName').value.trim();
    if (!userName) {
      alert("请先输入你的姓名！");
      return;
    }
    localStorage.setItem('userInfo', JSON.stringify({
      name: userName,
      file: fileName
    }));
    location.href = 'test.html';
  }
</script>
