<!DOCTYPE html>
<meta charset="utf-8">
<title>é€‰æ‹©é¢˜åº“ | è‹±è¯­ç­”é¢˜ç³»ç»Ÿ</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Microsoft YaHei', Arial, sans-serif;
  }
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px;
  }
  .container {
    max-width: 500px;
    width: 100%;
    margin: 30px auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    padding: 30px;
  }
  h1 {
    color: #2c3e50;
    margin-bottom: 25px;
    font-size: 24px;
    font-weight: 600;
    text-align: center;
  }
  .form-group {
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    color: #34495e;
    font-weight: 500;
    font-size: 16px;
  }
  input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #e1e8ed;
    border-radius: 10px;
    font-size: 16px;
    transition: border 0.3s ease;
  }
  input:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
  }
  .file-list, .direction-list {
    margin-top: 20px;
  }
  .loading, .empty {
    text-align: center;
    padding: 30px;
    color: #7f8c8d;
    font-size: 16px;
  }
  .loading {
    color: #3498db;
  }
  .file-btn, .direction-btn {
    width: 100%;
    padding: 16px;
    margin: 8px 0;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .file-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
  }
  .direction-btn {
    background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    box-shadow: 0 4px 12px rgba(155, 89, 182, 0.2);
  }
  .file-btn:hover, .direction-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  }
  .back-btn {
    display: inline-block;
    margin-top: 20px;
    color: #3498db;
    text-decoration: none;
    font-size: 15px;
  }
  .step-title {
    font-size: 18px;
    color: #2c3e50;
    margin: 25px 0 15px 0;
    font-weight: 600;
  }
  .hidden {
    display: none;
  }
</style>
<div class="container">
  <h1>âœï¸ å¼€å§‹ç­”é¢˜</h1>
  
  <!-- æ­¥éª¤1ï¼šè¾“å…¥å§“å -->
  <div class="form-group">
    <label for="userName">è¯·è¾“å…¥ä½ çš„å§“å</label>
    <input type="text" id="userName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" required>
  </div>
  
  <!-- æ­¥éª¤2ï¼šé€‰æ‹©é¢˜åº“ -->
  <div class="step-title">æ­¥éª¤1ï¼šé€‰æ‹©é¢˜åº“</div>
  <div class="file-list" id="fileList">
    <div class="loading">ğŸ”„ æ­£åœ¨åŠ è½½é¢˜åº“...</div>
  </div>
  
  <!-- æ­¥éª¤3ï¼šé€‰æ‹©ç¿»è¯‘æ–¹å‘ï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div class="step-title" id="directionTitle" class="hidden">æ­¥éª¤2ï¼šé€‰æ‹©ç¿»è¯‘æ–¹å‘</div>
  <div class="direction-list" id="directionList" class="hidden">
    <!-- ç¿»è¯‘æ–¹å‘æŒ‰é’®ä¼šåŠ¨æ€ç”Ÿæˆ -->
  </div>
  
  <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const GITHUB_REPO = "jojoWangkun/English-test";
const FOLDER = "questions";

let selectedFile = "";
let fileType = ""; // cn:ä¸­è‹±, vn:è‹±è¶Š

window.onload = loadFileList;

// åŠ è½½é¢˜åº“åˆ—è¡¨
async function loadFileList() {
  const el = document.getElementById('fileList');
  try {
    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FOLDER}`);
    if (!response.ok) throw new Error("é¢˜åº“åŠ è½½å¤±è´¥");
    
    const files = await response.json();
    const excelFiles = files.filter(file => file.name.endsWith('.xlsx'));
    
    if (excelFiles.length === 0) {
      el.innerHTML = "<div class='empty'>ğŸ“‚ æš‚æ— å¯ç”¨é¢˜åº“</div>";
      return;
    }
    
    let html = '';
    excelFiles.forEach(file => {
      html += `<button class="file-btn" onclick="selectFile('${file.name}')">ğŸ“š ${file.name}</button>`;
    });
    el.innerHTML = html;
  } catch (error) {
    el.innerHTML = `<div class="empty">âŒ åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
    console.error("é¢˜åº“åŠ è½½é”™è¯¯ï¼š", error);
  }
}

// é€‰æ‹©é¢˜åº“å¹¶æ£€æµ‹ç±»å‹
async function selectFile(fileName) {
  selectedFile = fileName;
  
  // åŠ è½½æ–‡ä»¶æ£€æµ‹ç±»å‹
  try {
    const requestUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FOLDER}/${fileName}`;
    const response = await fetch(requestUrl);
    const fileData = await response.json();
    const content = atob(fileData.content);
    const uint8Array = new Uint8Array(content.length);
    for (let i = 0; i < content.length; i++) {
      uint8Array[i] = content.charCodeAt(i);
    }

    const workbook = XLSX.read(uint8Array);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    
    // æ£€æµ‹ç±»å‹
    const firstValidRow = rawData.find(row => row.length >=3 && row[1]);
    if (firstValidRow && firstValidRow[2]) {
      fileType = "cn"; // ä¸­è‹±
    } else if (firstValidRow && firstValidRow.length >=4 && firstValidRow[3]) {
      fileType = "vn"; // è‹±è¶Š
    } else {
      alert("é¢˜åº“æ ¼å¼é”™è¯¯ï¼è¯·æ£€æŸ¥Excelåˆ—æ•°");
      return;
    }
    
    // æ˜¾ç¤ºç¿»è¯‘æ–¹å‘é€‰æ‹©
    document.getElementById('directionTitle').classList.remove('hidden');
    document.getElementById('directionList').classList.remove('hidden');
    renderDirectionButtons();
    
  } catch (error) {
    alert(`æ£€æµ‹é¢˜åº“ç±»å‹å¤±è´¥ï¼š${error.message}`);
    console.error(error);
  }
}

// ç”Ÿæˆç¿»è¯‘æ–¹å‘æŒ‰é’®
function renderDirectionButtons() {
  const el = document.getElementById('directionList');
  let html = '';
  
  if (fileType === "cn") {
    // ä¸­è‹±ç¿»è¯‘æ–¹å‘
    html += `
      <button class="direction-btn" onclick="startTest('cn2en')">ä¸­è¯‘è‹±</button>
      <button class="direction-btn" onclick="startTest('en2cn')">è‹±è¯‘ä¸­</button>
      <button class="direction-btn" onclick="startTest('both')">ä¸­è‹±äº’è¯‘</button>
    `;
  } else {
    // è‹±è¶Šç¿»è¯‘æ–¹å‘ï¼ˆè¶Šå—è¯­æ˜¾ç¤ºï¼‰
    html += `
      <button class="direction-btn" onclick="startTest('vn2en')">Tiáº¿ng Viá»‡t sang Tiáº¿ng Anh (è¶Šè¯‘è‹±)</button>
      <button class="direction-btn" onclick="startTest('en2vn')">Tiáº¿ng Anh sang Tiáº¿ng Viá»‡t (è‹±è¯‘è¶Š)</button>
      <button class="direction-btn" onclick="startTest('both')">Äá»‘i dá»‹ch láº«n nhau (è‹±è¶Šäº’è¯‘)</button>
    `;
  }
  
  el.innerHTML = html;
}

// å¼€å§‹ç­”é¢˜
function startTest(direction) {
  const userName = document.getElementById('userName').value.trim();
  if (!userName) {
    alert("è¯·å…ˆè¾“å…¥ä½ çš„å§“åï¼");
    return;
  }
  
  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  localStorage.setItem('userInfo', JSON.stringify({
    name: userName,
    file: selectedFile,
    type: fileType,
    direction: direction,
    startTime: new Date().getTime()
  }));
  
  location.href = 'test.html';
}
</script>
