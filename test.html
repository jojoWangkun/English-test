<!DOCTYPE html>
<meta charset="utf-8">
<title>答题页面</title>
<style>
  body{max-width:600px;margin:20px auto;font-family:Arial;padding:0 20px}
  .progress{text-align:center;font-size:18px;margin:10px 0;font-weight:bold}
  .question-card{border:1px solid #ccc;padding:25px;border-radius:8px;margin:20px 0}
  .question{font-size:20px;margin:20px 0;padding:15px;background:#f9f9f9;border-radius:8px;text-align:center}
  input{width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;margin:20px 0}
  button{width:100%;padding:12px;font-size:18px;border:none;border-radius:8px;color:white;background:#2196F3;cursor:pointer}
  button:hover{opacity:0.9}
  .error{text-align:center;color:red;font-size:16px;margin:20px 0;padding:15px;border:1px solid #f8d7da;background:#fef0f0;border-radius:8px}
</style>
<div class="progress" id="progress">加载题库中...</div>
<div class="question-card" id="questionCard" style="display:none">
  <div class="question" id="question"></div>
  <input type="text" id="answer" placeholder="请输入你的答案" autofocus>
  <button onclick="submitAnswer()">提交并下一题</button>
</div>
<div id="error" class="error" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // ✅ 修复process未定义：本地直接填令牌
  const GITHUB_TOKEN = process.env.GITHUB_TOKEN || "";
  const GITHUB_REPO = "jojoWangkun/English-test";
  const FOLDER_PATH = "questions";
  const SCORE_FILE = "答题成绩汇总.xlsx";

  // 答题相关变量
  let questions = [];
  let currentIndex = 0;
  let correctCount = 0;
  let userName = "";
  let questionFileName = "";

  window.onload = init;

  // 初始化
  async function init() {
    const errorEl = document.getElementById('error');
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));

    if (!userInfo || !userInfo.name || !userInfo.file) {
      errorEl.style.display = "block";
      errorEl.textContent = "请先返回上一页，输入姓名并选择题库！";
      return;
    }
    userName = userInfo.name;
    questionFileName = userInfo.file;

    await loadQuestions();
  }

  // 加载并解析题库
  async function loadQuestions() {
    const progress = document.getElementById('progress');
    const errorEl = document.getElementById('error');

    try {
      progress.textContent = `加载题库：${questionFileName}...`;
      const requestUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FOLDER_PATH}/${questionFileName}`;
      const response = await fetch(requestUrl, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        mode: 'cors'
      });

      if (!response.ok) throw new Error("选中的题库文件不存在，请先上传！");

      const fileData = await response.json();
      const content = atob(fileData.content);
      const arrayBuffer = new ArrayBuffer(content.length);
      const uint8Array = new Uint8Array(arrayBuffer);
      for (let i = 0; i < content.length; i++) uint8Array[i] = content.charCodeAt(i);

      const workbook = XLSX.read(arrayBuffer);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      questions = rawData.filter(row => row.length >= 3 && row[0] && row[1] && row[2]).map(row => ({
        序号: row[0],
        英文: row[1].toString().trim(),
        中文: row[2].toString().trim()
      }));

      if (questions.length === 0) throw new Error("题库中无有效数据（需1列序号、2列英文、3列中文）！");

      document.getElementById('questionCard').style.display = "block";
      showCurrentQuestion();
    } catch (error) {
      errorEl.style.display = "block";
      errorEl.textContent = error.message;
      progress.textContent = "";
      console.error("题库解析错误：", error);
    }
  }

  // 显示当前题目
  function showCurrentQuestion() {
    const progress = document.getElementById('progress');
    const questionEl = document.getElementById('question');
    const answerEl = document.getElementById('answer');

    progress.textContent = `第 ${currentIndex + 1} 题 / 共 ${questions.length} 题`;
    const currentQ = questions[currentIndex];
    const isEn2Cn = Math.random() > 0.5;

    localStorage.setItem('correctAns', isEn2Cn ? currentQ.中文 : currentQ.英文);
    questionEl.textContent = isEn2Cn ? `英译中：${currentQ.英文}` : `中译英：${currentQ.中文}`;
    answerEl.value = "";
    answerEl.focus();
  }

  // 提交答案
  function submitAnswer() {
    const answerEl = document.getElementById('answer');
    const userAns = answerEl.value.trim().toLowerCase();
    const correctAns = localStorage.getItem('correctAns').trim().toLowerCase();

    if (userAns === correctAns) correctCount++;
    currentIndex++;

    if (currentIndex >= questions.length) {
      saveScoreToGitHub();
      return;
    }
    showCurrentQuestion();
  }

  // 保存成绩到GitHub
  async function saveScoreToGitHub() {
    const total = questions.length;
    const score = ((correctCount / total) * 100).toFixed(1);
    const now = new Date().toLocaleString();

    try {
      const scoreUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${SCORE_FILE}`;
      // 先获取现有成绩文件
      let response = await fetch(scoreUrl, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        mode: 'cors'
      });

      let sha = null;
      let scoreData = [["姓名", "题库名称", "总题数", "正确题数", "得分", "答题时间"]];

      if (response.ok) {
        const fileData = await response.json();
        sha = fileData.sha;
        const content = atob(fileData.content);
        const arrayBuffer = new ArrayBuffer(content.length);
        const uint8Array = new Uint8Array(arrayBuffer);
        for (let i = 0; i < content.length; i++) uint8Array[i] = content.charCodeAt(i);

        const workbook = XLSX.read(arrayBuffer);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        scoreData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      }

      // 追加新成绩
      scoreData.push([userName, questionFileName, total, correctCount, score, now]);

      // 生成新Excel
      const workbook = XLSX.utils.book_new();
      const sheet = XLSX.utils.aoa_to_sheet(scoreData);
      XLSX.utils.book_append_sheet(workbook, sheet, "成绩汇总");
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const base64Content = btoa(String.fromCharCode(...new Uint8Array(excelBuffer)));

      // 上传/更新成绩文件
      await fetch(scoreUrl, {
        method: sha ? "PUT" : "POST",
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `保存${userName}的答题成绩`,
          content: base64Content,
          sha: sha,
          branch: 'main'
        }),
        mode: 'cors'
      });

      // 跳结果页
      localStorage.setItem('result', JSON.stringify({
        name: userName,
        file: questionFileName,
        total: total,
        correct: correctCount,
        score: score
      }));
      location.href = 'result.html';
    } catch (error) {
      alert(`成绩保存失败：${error.message}，但答题已完成！`);
      localStorage.setItem('result', JSON.stringify({
        name: userName,
        file: questionFileName,
        total: total,
        correct: correctCount,
        score: score
      }));
      location.href = 'result.html';
    }
  }
</script>
