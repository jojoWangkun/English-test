<!DOCTYPE html>
<meta charset="utf-8">
<title>答题</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css">
<div class="container mt-4">
  <h1 class="text-center">答题中</h1>
  <div id="box" class="mt-4"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const GITHUB_TOKEN = "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";
const GITHUB_REPO = "jojoWangkun/English-test";
const file = localStorage.getItem('currentFile')

if(!file){alert("请先选择题库");location.href='student.html'}

async function start(){
  const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/questions/${file}`,{
    headers:{Authorization:`token ${GITHUB_TOKEN}`}
  })
  if(!r.ok){alert("题库不存在");return}
  const d = await r.json()
  const ab = Uint8Array.from(atob(d.content),c=>c.charCodeAt(0))
  const wb = XLSX.read(ab)
  const qs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
  render(qs)
}

let idx=0,right=0
function render(qs){
  if(idx>=qs.length){
    localStorage.setItem('score',`${right}/${qs.length}`)
    location.href='result.html'
    return
  }
  const q = qs[idx]
  document.getElementById('box').innerHTML=`
    <div class="card p-3">
      <div class="h5">${q.英文}</div>
      <input id="ans" class="form-control my-3" placeholder="请输入中文">
      <button class="btn btn-primary" onclick="next('${q.中文}',qs)">下一题</button>
    </div>
  `
}

function next(ans,qs){
  if(document.getElementById('ans').value.trim()===ans.trim())right++
  idx++
  render(qs)
}

start()
</script>