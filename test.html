<!DOCTYPE html>
<meta charset="utf-8">
<title>答题中</title>
<style>
  body{max-width:600px;margin:20px auto;font-family:Arial;padding:0 20px}
  .progress{text-align:center;font-size:18px;margin:10px 0}
  .card{border:1px solid #ccc;padding:25px;border-radius:8px;margin:20px 0}
  .q{font-size:20px;padding:15px;background:#f9f9f9;border-radius:8px;text-align:center}
  input{width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:8px;margin:20px 0}
  button{width:100%;padding:12px;font-size:18px;border:none;border-radius:8px;color:white;background:#2196F3;cursor:pointer}
  .error{color:red;text-align:center;padding:15px}
</style>
<div class="progress" id="progress">加载中...</div>
<div class="card" id="box" style="display:none">
  <div class="q" id="q"></div>
  <input id="ans" autofocus>
  <button onclick="next()">下一题</button>
</div>
<div id="err" class="error" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const REPO = "jojoWangkun/English-test";
const FOLDER = "questions";

let qs = [], cur=0, ok=0, name="", file="";

window.onload = init;
async function init() {
  const u = JSON.parse(localStorage.getItem('user'));
  if (!u) { location.href='student.html'; return; }
  name = u.name; file = u.file;
  await load();
}

async function load() {
  const p = document.getElementById('progress');
  const err = document.getElementById('err');
  try {
    const r = await fetch(`https://api.github.com/repos/${REPO}/contents/${FOLDER}/${file}`);
    const d = await r.json();
    const b = atob(d.content);
    const u8 = new Uint8Array(b.length);
    for(let i=0;i<b.length;i++)u8[i]=b.charCodeAt(i);
    const wb = XLSX.read(u8);
    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
    qs = data.filter(r=>r.length>=3&&r[0]&&r[1]&&r[2]).map(r=>({
      en:r[1].trim(), cn:r[2].trim()
    }));
    show();
    document.getElementById('box').style.display='block';
  }catch(e){
    err.textContent='加载失败：'+e.message; err.style.display='block'; p.style.display='none';
  }
}

function show() {
  const p = document.getElementById('progress');
  const q = document.getElementById('q');
  const ans = document.getElementById('ans');
  p.textContent = `${cur+1}/${qs.length}`;
  const item = qs[cur];
  const isEn = Math.random()>.5;
  localStorage.setItem('ok',isEn?item.cn:item.en);
  q.textContent = isEn ? `英译中：${item.en}` : `中译英：${item.cn}`;
  ans.value=''; ans.focus();
}

function next() {
  const a = document.getElementById('ans').value.trim().toLowerCase();
  const c = localStorage.getItem('ok').trim().toLowerCase();
  if(a===c) ok++;
  cur++;
  if(cur>=qs.length){
    localStorage.setItem('res',JSON.stringify({
      name, total:qs.length, ok, score:((ok/qs.length)*100).toFixed(1)
    }));
    location.href='result.html';
    return;
  }
  show();
}
</script>
