<!DOCTYPE html>
<meta charset="utf-8">
<title>ä¸Šä¼ é¢˜åº“-Excel</title>
<style>
  body{max-width:500px;margin:50px auto;font-family:Arial;padding:0 20px}
  .upload-card{border:1px solid #ccc;padding:30px;border-radius:8px;margin:20px 0;text-align:center}
  #fileInput{display:none}
  .upload-btn{padding:15px 30px;background:#2196F3;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin:20px 0}
  .upload-btn:hover{opacity:0.9}
  .hint{color:#666;margin:10px 0;line-height:1.6}
  .success{color:#4CAF50;font-weight:bold;margin:10px 0;padding:10px;background:#e8f5e9;border-radius:8px}
  .error{color:#f44336;font-weight:bold;margin:10px 0;padding:10px;background:#ffebee;border-radius:8px}
  .loading{color:#2196F3;margin:10px 0}
</style>
<div class="upload-card">
  <h2>ä¸Šä¼ é¢˜åº“Excelæ–‡ä»¶</h2>
  <p class="hint">âœ… æ ¼å¼è¦æ±‚ï¼šæ— è¡¨å¤´ï¼Œ1åˆ—åºå·ã€2åˆ—è‹±æ–‡ã€3åˆ—ä¸­æ–‡<br>âœ… ä»…æ”¯æŒ.xlsxæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡10MB</p>
  <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©Excelæ–‡ä»¶</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileSelect(event)">
  <div id="status"></div>
  <button class="upload-btn" style="background:#607d8b;margin-top:10px" onclick="location.href='index.html'">è¿”å›é¦–é¡µ</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // âœ… ä¿®å¤processæœªå®šä¹‰ï¼šæœ¬åœ°ç›´æ¥å¡«ä»¤ç‰Œ
  const GITHUB_TOKEN = process.env.GITHUB_TOKEN || "";
  const GITHUB_REPO = "jojoWangkun/English-test";
  const FOLDER_PATH = "questions";

  // å¤„ç†æ–‡ä»¶é€‰æ‹©
  async function handleFileSelect(event) {
    const file = event.target.files[0];
    const status = document.getElementById('status');
    if (!file) return;

    // éªŒè¯æ–‡ä»¶æ ¼å¼
    if (!file.name.endsWith('.xlsx')) {
      status.className = "error";
      status.textContent = "âŒ ä»…æ”¯æŒ.xlsxæ ¼å¼ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼";
      return;
    }

    status.className = "loading";
    status.textContent = "ğŸ”„ æ­£åœ¨è§£æExcelå¹¶ä¸Šä¼ ...";

    try {
      // 1. è§£æExcelæ–‡ä»¶ï¼ŒéªŒè¯æ ¼å¼
      const workbook = await readExcelFile(file);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      // è¿‡æ»¤æœ‰æ•ˆæ•°æ®
      const validData = rawData.filter(row => row.length >= 3 && row[0] && row[1] && row[2]);
      if (validData.length === 0) {
        throw new Error("Excelæ— æœ‰æ•ˆæ•°æ®ï¼éœ€æ»¡è¶³ï¼šæ— è¡¨å¤´ã€1åˆ—åºå·ã€2åˆ—è‹±æ–‡ã€3åˆ—ä¸­æ–‡");
      }

      // 2. è½¬æ¢ä¸ºBase64ï¼Œå‡†å¤‡ä¸Šä¼ 
      const excelBuffer = await fileToArrayBuffer(file);
      const base64Content = btoa(String.fromCharCode(...new Uint8Array(excelBuffer)));

      // 3. ä¸Šä¼ åˆ°GitHubçš„questionsæ–‡ä»¶å¤¹
      const fileName = file.name;
      const uploadUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FOLDER_PATH}/${fileName}`;

      // å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼ˆè·å–shaå€¼ï¼‰
      let sha = null;
      try {
        const checkRes = await fetch(uploadUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          mode: 'cors'
        });
        if (checkRes.ok) {
          const checkData = await checkRes.json();
          sha = checkData.sha; // å­˜åœ¨åˆ™è·å–shaï¼Œç”¨äºè¦†ç›–
        }
      } catch (err) {
        console.log("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†æ–°å»ºï¼š", err.message);
      }

      // ä¸Šä¼ /æ›´æ–°æ–‡ä»¶
      const uploadRes = await fetch(uploadUrl, {
        method: sha ? "PUT" : "POST",
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `ä¸Šä¼ é¢˜åº“ï¼š${fileName}`,
          content: base64Content,
          sha: sha,
          branch: 'main'
        }),
        mode: 'cors'
      });

      if (!uploadRes.ok) {
        const errData = await uploadRes.json();
        throw new Error(`ä¸Šä¼ å¤±è´¥ï¼š${errData.message}ï¼ˆçŠ¶æ€ç ï¼š${uploadRes.status}ï¼‰`);
      }

      // ä¸Šä¼ æˆåŠŸ
      status.className = "success";
      status.textContent = `âœ… ä¸Šä¼ æˆåŠŸï¼${fileName} å·²ä¿å­˜åˆ°GitHubçš„${FOLDER_PATH}æ–‡ä»¶å¤¹`;
      event.target.value = ""; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©

    } catch (error) {
      status.className = "error";
      status.textContent = `âŒ ä¸Šä¼ å¤±è´¥ï¼š${error.message}`;
      console.error("ä¸Šä¼ è¯¦ç»†é”™è¯¯ï¼š", error);
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šè¯»å–Excelæ–‡ä»¶
  function readExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          resolve(workbook);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ–‡ä»¶è½¬ArrayBuffer
  function fileToArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }
</script>
