<!DOCTYPE html>
<meta charset="utf-8">
<title>出题人-成绩查看</title>
<style>
  body{max-width:1000px;margin:20px auto;font-family:Arial}
  .card{border:1px solid #ccc;padding:20px;margin:20px 0;border-radius:8px}
  table{width:100%;border-collapse:collapse;margin:20px 0}
  th,td{border:1px solid #ccc;padding:12px;text-align:center}
  th{background:#f0f0f0}
  .empty{text-align:center;padding:30px;color:#666;border:1px dashed #ccc;border-radius:8px}
</style>
<div class="card">
  <h2>答题成绩汇总</h2>
  <div id="scoreList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // ✅ 第一步：先定义所有变量
  const GITHUB_TOKEN = process.env.GITHUB_TOKEN || ""; // Netlify环境变量
  const GITHUB_REPO = "jojoWangkun/English-test"; // 先定义仓库名
  const SCORE_FILE = "答题成绩汇总.xlsx";

  // ✅ 第二步：再使用变量
  window.onload = loadScores;

  // 加载成绩Excel
  async function loadScores() {
    const scoreList = document.getElementById('scoreList');
    scoreList.innerHTML = "<div class='empty'>正在加载成绩...</div>";

    try {
      // 这里使用之前定义的变量
      const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${SCORE_FILE}`;
      const res = await fetch(url, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });

      if (!res.ok) {
        scoreList.innerHTML = "<div class='empty'>暂无答题成绩</div>";
        return;
      }

      const fileData = await res.json();
      const content = atob(fileData.content);
      const arrayBuffer = new ArrayBuffer(content.length);
      const uint8Array = new Uint8Array(arrayBuffer);
      for (let i = 0; i < content.length; i++) uint8Array[i] = content.charCodeAt(i);

      const workbook = XLSX.read(arrayBuffer);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const scores = XLSX.utils.sheet_to_json(sheet);

      if (scores.length === 0) {
        scoreList.innerHTML = "<div class='empty'>暂无答题成绩</div>";
        return;
      }

      // 渲染成绩表格
      let html = `<table><tr><th>序号</th><th>姓名</th><th>题库名称</th><th>总题数</th><th>正确题数</th><th>得分</th><th>答题时间</th></tr>`;
      scores.forEach((item, idx) => {
        html += `<tr>
          <td>${idx+1}</td>
          <td>${item.姓名||""}</td>
          <td>${item.题库名称||""}</td>
          <td>${item.总题数||""}</td>
          <td>${item.正确题数||""}</td>
          <td>${item.得分||""}</td>
          <td>${item.答题时间||""}</td>
        </tr>`;
      });
      html += `</table>`;
      scoreList.innerHTML = html;
    } catch (e) {
      scoreList.innerHTML = `<div class='empty'>加载失败：${e.message}</div>`;
    }
  }
</script>
