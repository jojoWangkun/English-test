<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩汇总 - 英语考核系统（老师端）</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; }
        .container { border: 1px solid #ccc; padding: 30px; border-radius: 10px; }
        h1 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        th, td { border: 1px solid #ccc; padding: 12px; text-align: left; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .empty { text-align: center; color: #666; font-size: 18px; margin: 50px 0; }
        .loading { text-align: center; font-size: 18px; color: #666; margin: 50px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>答题成绩汇总</h1>
        <div class="loading" id="loading">正在加载成绩...</div>
        <table id="scoreTable" style="display: none;">
            <tr>
                <th>序号</th>
                <th>姓名</th>
                <th>答题模式</th>
                <th>总题数</th>
                <th>正确题数</th>
                <th>得分</th>
                <th>答题时间</th>
            </tr>
        </table>
        <div class="empty" id="empty" style="display: none;">暂无答题成绩</div>
    </div>

    <script>
        // ========== 配置项（和index.html一致） ==========
        const GITEE_TOKEN = "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";
        const GITEE_REPO = "jojoWangkun/English-test";
        const SCORE_FILE = "答题成绩汇总.xlsx";

        // ========== 工具函数 ==========
        async function loadScores() {
            const username = GITEE_REPO.split("/")[0];
            const repo = GITEE_REPO.split("/")[1];
            const url = `https://gitee.com/api/v5/repos/${username}/${repo}/contents/${SCORE_FILE}`;

            try {
                const res = await fetch(url, {
                    headers: { "Authorization": `token ${GITEE_TOKEN}` }
                });
                if (res.status === 200) {
                    const data = await res.json();
                    if (data.content) {
                        // 解析Excel
                        const decoded = atob(data.content);
                        const arrayBuffer = new ArrayBuffer(decoded.length);
                        const uint8Array = new Uint8Array(arrayBuffer);
                        for (let i = 0; i < decoded.length; i++) {
                            uint8Array[i] = decoded.charCodeAt(i);
                        }
                        const workbook = XLSX.read(arrayBuffer);
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        return rows;
                    }
                }
            } catch (e) {
                console.error("加载成绩失败：", e);
            }
            return [];
        }

        // ========== 主逻辑 ==========
        async function renderScores() {
            const scores = await loadScores();
            document.getElementById("loading").style.display = "none";

            if (scores.length === 0) {
                document.getElementById("empty").style.display = "block";
                return;
            }

            // 渲染表格
            const table = document.getElementById("scoreTable");
            scores.forEach((score, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${score.姓名 || ""}</td>
                    <td>${score.答题模式 || ""}</td>
                    <td>${score.总题数 || ""}</td>
                    <td>${score.正确题数 || ""}</td>
                    <td>${score.得分 || ""}</td>
                    <td>${score.答题时间 || ""}</td>
                `;
                table.appendChild(tr);
            });
            table.style.display = "table";
        }

        // 引入SheetJS
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        script.onload = renderScores;
        document.head.appendChild(script);
    </script>
</body>
</html>