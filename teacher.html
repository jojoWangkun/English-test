<!DOCTYPE html>
<meta charset="utf-8">
<title>出题人后台</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css">
<div class="container mt-4">
  <h1 class="text-center mb-4">出题人后台</h1>

  <div class="card mb-4">
    <div class="card-header">上传Excel题库（支持多个）</div>
    <div class="card-body">
      <input type="file" id="file" accept=".xlsx" class="form-control mb-2">
      <button class="btn btn-primary w-100" onclick="upload()">上传题库</button>
      <div id="msg" class="mt-2"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">已上传题库列表</div>
    <div class="card-body" id="list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const GITHUB_TOKEN = "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";
const GITHUB_REPO = "jojoWangkun/English-test";

async function upload(){
  const f = document.getElementById('file').files[0]
  if(!f)return show("请选文件","danger")
  const name = f.name.replace(/[^a-zA-Z0-9.]/g,'_')
  const ab = await f.arrayBuffer()
  const wb = XLSX.read(ab)
  const ws = wb.Sheets[wb.SheetNames[0]]
  const arr = XLSX.utils.sheet_to_json(ws)
  if(!arr.length||!arr[0].编号||!arr[0].英文||!arr[0].中文)
    return show("必须有：编号、英文、中文","danger")
  const buf = XLSX.write(wb,{type:"array",bookType:"xlsx"})
  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)))
  const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/questions/${name}`,{
    method:"PUT",headers:{Authorization:`token ${GITHUB_TOKEN}`},
    body:JSON.stringify({message:"上传",content:b64})
  })
  show(r.ok?"上传成功":"失败","success")
  if(r.ok)setTimeout(list,1000)
}

async function del(n){
  const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/questions/${n}`)
  const d = await r.json()
  await fetch(d.url,{method:"DELETE",headers:{Authorization:`token ${GITHUB_TOKEN}`},
    body:JSON.stringify({message:"删除",sha:d.sha})
  })
  list()
}

async function list(){
  const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/questions`,{
    headers:{Authorization:`token ${GITHUB_TOKEN}`}
  })
  const arr = r.ok?await r.json():[]
  const dom = arr.filter(i=>i.name.endsWith('.xlsx')).map(i=>`
    <div class="d-flex justify-content-between border p-2 mb-1">
      <div>${i.name}</div>
      <button class="btn btn-sm btn-danger" onclick="del('${i.name}')">删除</button>
    </div>
  `).join('')
  document.getElementById('list').innerHTML = dom || "<div>暂无题库</div>"
}

function show(t,c){
  document.getElementById('msg').innerHTML=`<div class="alert alert-${c}">${t}</div>`
}

window.onload=list
</script>